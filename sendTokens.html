<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayerZero OFT Transfer</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <h2>LayerZero OFT Transfer</h2>
    <button id="connectWallet">Connect Wallet</button>
    <p><strong>Connected Address:</strong> <span id="walletAddress">Not connected</span></p>
    <p><strong>OFT ChainId:</strong> <span id="oftChainId">Not connected</span></p>
    <p><strong>OFT Balance:</strong> <span id="balance">0</span></p>

    <h3>Send Tokens</h3>
    <label>Recipient Address:</label>
    <input type="text" id="recipient" placeholder="0xRecipientAddress" />
    <br />
    <label>Amount:</label>
    <input type="number" id="amount" placeholder="Enter amount" />
    <br />
    <label>Destination Chain:</label>
    <select id="destinationChain">
        <option value="40245">Base Testnet</option>
        <option value="40287">Linea Testnet</option>
    </select>
    <br />
    <button id="sendTokens">Send</button>

    <h3>Status:</h3>
    <p id="status">Idle</p>
    <h3>Transaction Details:</h3>
    <pre id="txDetails">None</pre>

    <script>
        let provider, signer, oftContract;
        const oftContracts = {
            84532: "0xEeec2DA1372cC2BE54354acb2a501Bcc4d4EcCA0", // Base Testnet
            59141: "0xEeec2DA1372cC2BE54354acb2a501Bcc4d4EcCA0"  // Linea Testnet
        };

        async function connectWallet() {
            if (!window.ethereum) {
                alert("MetaMask is required!");
                return;
            }
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const address = await signer.getAddress();
            document.getElementById("walletAddress").innerText = address;
            await updateOFTContract();
        }

        async function updateOFTContract() {
            const network = await provider.getNetwork();
            const chainId = network.chainId;
            console.log("chainId", chainId);
            const oftAddress = oftContracts[chainId];

            if (!oftAddress) {
                alert("Unsupported network! Switch to Base, or Linea testnets.");
                return;
            }

            const oftAbi = [
                "function balanceOf(address owner) view returns (uint256)",
                "function estimateSendFee(uint32, bytes32, uint256, bool, bytes) view returns (uint256 nativeFee, uint256 lzTokenFee)",
                "function send((uint32, bytes32, uint256, uint256, bytes, bytes, bytes), (uint256, uint256), address) payable",
                "function quoteSend((uint32, bytes32, uint256, uint256, bytes, bytes, bytes), bool) view returns (uint256 nativeFee, uint256 lzTokenFee)"
            ];
            
            oftContract = new ethers.Contract(oftAddress, oftAbi, signer);
            await updateBalance();
            document.getElementById("oftChainId").innerText = chainId;
        }

        async function updateBalance() {
            if (!oftContract) return;
            const address = await signer.getAddress();
            const balance = await oftContract.balanceOf(address);
            document.getElementById("balance").innerText = ethers.utils.formatEther(balance);
        }

        document.getElementById("sendTokens").addEventListener("click", async () => {
            if (!signer) return alert("Connect your wallet first!");
            const network = await provider.getNetwork();
            const chainId = network.chainId;
            const oftAddress = oftContracts[chainId];

            if (!oftAddress) {
                alert("Unsupported network! Please switch to Base, or Linea testnets.");
                return;
            }

            const recipient = document.getElementById("recipient").value;
            const amount = document.getElementById("amount").value;
            const destinationChainId = document.getElementById("destinationChain").value;

            if (!ethers.utils.isAddress(recipient)) return alert("Invalid recipient address!");
            if (!amount || isNaN(amount)) return alert("Invalid amount!");

            const amountWei = ethers.utils.parseEther(amount);
            console.log("amountWei", amountWei);    

            const recipientEncoded = ethers.utils.hexZeroPad(recipient, 32);
            const options = "0x00030100210100000000000000000000000000030d400000000000000000000000000000000a";

            document.getElementById("status").innerText = "Estimating gas...";

            
            try {
                const sendParam = [
                    parseInt(destinationChainId), // dstEid
                    recipientEncoded,             // to
                    amountWei,                    // amountLD
                    amountWei,                    // minAmountLD
                    options,                      // extraOptions
                    "0x",                         // composeMsg
                    "0x"                          // oftCmd
                ];
                
                console.log({sendParam});

                const [nativeFee, lzTokenFee] = await oftContract.quoteSend(sendParam, false);

                console.log({nativeFee: nativeFee.toString(), lzTokenFee: lzTokenFee.toString()});

                const messagingFee = [
                    nativeFee.toString(),
                    lzTokenFee.toString()
            ];

                console.log({messagingFee});

                const refundAddress = await signer.getAddress();

                document.getElementById("txDetails").innerText = JSON.stringify({
                    sendParam,
                    messagingFee,
                    refundAddress
                }, null, 4);

                console.log(" value: messagingFee.nativeFee", messagingFee.nativeFee);

                // console.log("ethers.BigNumber.from(nativeFee.toString())", ethers.BigNumber.from(nativeFee.toString()));

                console.log({ sendParam,
                    messagingFee,
                    refundAddress,
                    value: messagingFee.nativeFee })

                const tx = await oftContract.send(
                    sendParam,
                    messagingFee,
                    refundAddress,
                    { value: ethers.BigNumber.from(nativeFee.toString()) }
                );

                document.getElementById("status").innerText = "Transaction pending...";
                const receipt = await tx.wait();

                document.getElementById("status").innerText = "Transfer successful!";
                await updateBalance();
            } catch (error) {
                console.error(error);
                document.getElementById("status").innerText = "Transaction failed!";
            }
        });

        document.getElementById("connectWallet").addEventListener("click", connectWallet);
    </script>
</body>
</html>
