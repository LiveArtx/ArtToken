<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayerZero OFT Transfer</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <h2>LayerZero OFT Transfer</h2>
    <button id="connectWallet">Connect Wallet</button>
    <p><strong>Connected Address:</strong> <span id="walletAddress">Not connected</span></p>
    <p><strong>OFT Balance:</strong> <span id="balance">0</span></p>

    <h3>Send Tokens</h3>
    <label>Recipient Address:</label>
    <input type="text" id="recipient" placeholder="0xRecipientAddress" />
    <br />
    <label>Amount:</label>
    <input type="number" id="amount" placeholder="Enter amount" />
    <br />
    <label>Destination Chain:</label>
    <select id="destinationChain">
        <option value="40245">Base Testnet</option>
        <option value="40267">Amoy Testnet</option>
        <option value="40287">Linea Testnet</option>
    </select>
    <br />
    <button id="sendTokens">Send</button>

    <h3>Status:</h3>
    <p id="status">Idle</p>
    <h3>Transaction Details:</h3>
    <pre id="txDetails">None</pre>

    <script>
        let provider, signer, oftContract;
        const oftContracts = {
            84532: "0xa4e3acCbF198E3E71540166254bB0BAB9aFC0F64", // Base Testnet
            80002: "0x2819490c746b50b6CFcB9011bd7cDD6a2bDA9F7B", // Amoy Testnet
            59140: "0xaf167d0aC8eeaA659Af93ADB0C8b5A1a4cd1F804"  // Linea Testnet
        };

        async function connectWallet() {
            if (!window.ethereum) {
                alert("MetaMask is required!");
                return;
            }
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const address = await signer.getAddress();
            document.getElementById("walletAddress").innerText = address;
            await updateOFTContract();
        }

        async function updateOFTContract() {
            const network = await provider.getNetwork();
            const chainId = network.chainId;
            const oftAddress = oftContracts[chainId];

            if (!oftAddress) {
                alert("Unsupported network! Switch to Base, Amoy, or Linea testnets.");
                return;
            }

            const oftAbi = [
                "function balanceOf(address owner) view returns (uint256)",
                "function estimateSendFee(uint32, bytes32, uint256, bool, bytes) view returns (uint256 nativeFee, uint256 lzTokenFee)",
                "function send((uint32, bytes32, uint256, uint256, bytes, bytes, bytes), (uint256, uint256), address) payable"
            ];
            
            oftContract = new ethers.Contract(oftAddress, oftAbi, signer);
            await updateBalance();
        }

        async function updateBalance() {
            if (!oftContract) return;
            const address = await signer.getAddress();
            const balance = await oftContract.balanceOf(address);
            document.getElementById("balance").innerText = ethers.utils.formatEther(balance);
        }

        document.getElementById("sendTokens").addEventListener("click", async () => {
            if (!signer) return alert("Connect your wallet first!");
            const network = await provider.getNetwork();
            const chainId = network.chainId;
            const oftAddress = oftContracts[chainId];

            if (!oftAddress) {
                alert("Unsupported network! Please switch to Base, Amoy, or Linea testnets.");
                return;
            }

            const recipient = document.getElementById("recipient").value;
            const amount = document.getElementById("amount").value;
            const destinationChainId = document.getElementById("destinationChain").value;

            if (!ethers.utils.isAddress(recipient)) return alert("Invalid recipient address!");
            if (!amount || isNaN(amount)) return alert("Invalid amount!");

            const amountWei = ethers.utils.parseEther(amount);
            const recipientEncoded = ethers.utils.hexZeroPad(recipient, 32);

            document.getElementById("status").innerText = "Estimating gas...";

            try {
                const sendParam = {
                    dstEid: parseInt(destinationChainId),
                    to: recipientEncoded,
                    amountLD: amountWei.toString(),
                    minAmountLD: amountWei.toString(),
                    extraOptions: "0x",
                    composeMsg: "0x",
                    oftCmd: "0x"
                };

                console.log({sendParam});

                const [nativeFee, lzTokenFee] = await oftContract.estimateSendFee(destinationChainId, recipientEncoded, amountWei, false, "0x");

              

                const messagingFee = {
                    nativeFee: nativeFee.toString(),
                    lzTokenFee: lzTokenFee.toString()
                };

                console.log({messagingFee});

                const refundAddress = await signer.getAddress();

                document.getElementById("txDetails").innerText = JSON.stringify({
                    sendParam,
                    messagingFee,
                    refundAddress
                }, null, 4);

                const tx = await oftContract.send(
                    sendParam,
                    messagingFee,
                    refundAddress,
                    { value: nativeFee }
                );

                document.getElementById("status").innerText = "Transaction pending...";
                const receipt = await tx.wait();

                const { msgReceipt, oftReceipt } = receipt.events.find(e => e.event === "MessageSent").args;

                document.getElementById("txDetails").innerText += `\n\nMessagingReceipt:\n${JSON.stringify({
                    guid: msgReceipt.guid,
                    nonce: msgReceipt.nonce.toString(),
                    fee: {
                        nativeFee: msgReceipt.fee.nativeFee.toString(),
                        lzTokenFee: msgReceipt.fee.lzTokenFee.toString()
                    }
                }, null, 4)}`;

                document.getElementById("txDetails").innerText += `\n\nOFTReceipt:\n${JSON.stringify({
                    amountSentLD: oftReceipt.amountSentLD.toString(),
                    amountReceivedLD: oftReceipt.amountReceivedLD.toString()
                }, null, 4)}`;

                document.getElementById("status").innerText = "Transfer successful!";
                await updateBalance();
            } catch (error) {
                console.error(error);
                document.getElementById("status").innerText = "Transaction failed!";
            }
        });

        document.getElementById("connectWallet").addEventListener("click", connectWallet);
    </script>
</body>
</html>
